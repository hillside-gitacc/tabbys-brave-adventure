<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tabby's Adventure">
    <title>Tabby's Brave School Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: -webkit-fill-available;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Arial Rounded MT Bold', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Animated background */
        .clouds {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 100px;
            animation: float linear infinite;
        }

        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 100px;
        }

        @keyframes float {
            from { transform: translateX(-200px); }
            to { transform: translateX(calc(100vw + 200px)); }
        }

        .game-container {
            background: white;
            border-radius: 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 10;
            animation: slideIn 0.5s ease-out;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .game-container {
                max-width: 900px;
                height: auto;
                min-height: 80vh;
                border-radius: 30px;
                margin: 20px;
            }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: max(env(safe-area-inset-top), 20px) 20px 20px;
            text-align: center;
            color: white;
            position: relative;
            flex-shrink: 0;
        }

        .game-header h1 {
            font-size: clamp(1.5em, 4vw, 2em);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .header-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .star-counter { font-size: 1.5em; }

        .twinkling-star {
            display: inline-block;
            animation: twinkle 1s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.3) rotate(180deg); opacity: 0.7; }
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 15px;
        }

        .progress-bar-track {
            background: rgba(255, 255, 255, 0.3);
            height: 30px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #84fab0 0%, #8fd3f4 100%);
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
        }

        .progress-emoji {
            font-size: 1.5em;
            animation: bounce 0.5s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .journey-map {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 0 10px;
        }

        .journey-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.5em;
            opacity: 0.4;
            transition: all 0.3s ease;
        }

        .journey-step.active { opacity: 1; transform: scale(1.3); }
        .journey-step.completed { opacity: 0.7; }

        .journey-line {
            flex: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 5px;
        }

        .audio-controls {
            position: absolute;
            top: max(env(safe-area-inset-top), 15px);
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .audio-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .audio-btn:active { background: rgba(255, 255, 255, 0.5); transform: scale(0.9); }
        .audio-btn.muted { background: rgba(255, 0, 0, 0.3); }

        .game-content {
            padding: 20px;
            padding-bottom: max(env(safe-area-inset-bottom), 20px);
            position: relative;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 1024px) {
            .game-content { padding: 30px; min-height: 500px; }
        }

        .scene-transition { animation: fadeIn 0.5s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .scene-image-container { position: relative; margin-bottom: 30px; }

        .scene-image {
            width: 100%;
            max-height: 40vh;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s ease;
            touch-action: manipulation;
        }

        .scene-image:active { transform: scale(0.98); }

        @media (min-width: 768px) {
            .scene-image { max-height: 400px; object-fit: cover; border-radius: 20px; }
            .scene-image:hover { transform: scale(1.02); }
        }

        .hidden-star {
            position: absolute;
            font-size: 2.5em;
            cursor: pointer;
            animation: float-star 2s ease-in-out infinite;
            transition: all 0.3s ease;
            touch-action: manipulation;
            padding: 10px;
        }

        .hidden-star:active { transform: scale(1.3) rotate(180deg); }

        @keyframes float-star {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .story-text {
            font-size: clamp(1.2em, 3.5vw, 1.4em);
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .choices { display: flex; flex-direction: column; gap: 15px; }

        .choice-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 25px;
            font-size: clamp(1.1em, 3vw, 1.3em);
            font-family: inherit;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            min-height: 60px;
            touch-action: manipulation;
        }

        .choice-btn::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .choice-btn:active { transform: scale(0.95); box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3); }

        @media (min-width: 768px) {
            .choice-btn:hover::before { width: 300px; height: 300px; }
            .choice-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
        }

        .choice-btn.brave { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .choice-btn .star-icon { margin-left: 5px; animation: twinkle 1s ease-in-out infinite; }

        .encouragement {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: clamp(1em, 2.5vw, 1.2em);
            text-align: center;
            color: #333;
            animation: bounceIn 0.6s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .characters-container { display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap; }

        .character {
            display: flex; flex-direction: column; align-items: center;
            animation: bounceIn 0.6s; cursor: pointer;
            transition: transform 0.3s ease; touch-action: manipulation;
        }

        .character:active { transform: scale(0.95); }
        @media (min-width: 768px) { .character:hover { transform: translateY(-10px); } }

        .character-avatar { width: 100px; height: 120px; position: relative; margin-bottom: 10px; }

        .character-head {
            width: 80px; height: 80px; border-radius: 50%;
            position: absolute; bottom: 20px; left: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: wave 2s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .character-hair { position: absolute; top: 0; width: 100%; height: 40px; border-radius: 50% 50% 0 0; }
        .character-eyes { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 15px; }
        .eye { width: 12px; height: 12px; background: #333; border-radius: 50%; position: relative; animation: blink 4s infinite; }

        @keyframes blink { 0%, 96%, 100% { height: 12px; } 98% { height: 2px; } }

        .eye::after { content: ''; width: 4px; height: 4px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; }

        .character-mouth {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 30px; height: 15px; border: 3px solid #333; border-top: none; border-radius: 0 0 30px 30px;
        }

        .character-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 50px; height: 25px; border-radius: 10px 10px 0 0; }
        .character-accessory { position: absolute; top: 15px; right: 5px; font-size: 1.5em; }
        .character-name { font-size: 1.1em; font-weight: bold; color: #333; }

        .character-milo .character-head { background: #ffd4a3; }
        .character-milo .character-hair { background: #8b5a3c; }
        .character-milo .character-body { background: #667eea; }
        .character-sadie .character-head { background: #ffd4a3; }
        .character-sadie .character-hair { background: #f5a623; }
        .character-sadie .character-body { background: #f093fb; }
        .character-isabelle .character-head { background: #ffd4a3; }
        .character-isabelle .character-hair { background: #d4a574; }
        .character-isabelle .character-body { background: #fcb69f; }
        .character-teddy .character-head { background: #ffd4a3; }
        .character-teddy .character-hair { background: #4a4a4a; }
        .character-teddy .character-body { background: #84fab0; }
        .character-collis .character-head { background: #ffd4a3; }
        .character-collis .character-hair { background: #b8860b; }
        .character-collis .character-body { background: #a8edea; }
        .character-kane .character-head { background: #ffd4a3; }
        .character-kane .character-hair { background: #8b4513; }
        .character-kane .character-body { background: #fed6e3; }

        .fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .firework { position: absolute; width: 5px; height: 5px; border-radius: 50%; animation: explode 1s ease-out forwards; }

        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .star-burst { position: fixed; font-size: 3em; pointer-events: none; z-index: 9999; animation: burstUp 1.5s ease-out forwards; }

        @keyframes burstUp {
            0% { transform: translateY(0) scale(0) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-100px) scale(1.5) rotate(180deg); opacity: 1; }
            100% { transform: translateY(-200px) scale(0.5) rotate(360deg); opacity: 0; }
        }

        .confetti { position: fixed; width: 10px; height: 10px; pointer-events: none; z-index: 9999; animation: fall 2s ease-in forwards; }

        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .achievements-btn {
            position: fixed;
            bottom: max(env(safe-area-inset-bottom), 20px);
            right: max(env(safe-area-inset-right), 20px);
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white; border: none; width: 60px; height: 60px;
            border-radius: 50%; font-size: 2em; cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 100; transition: all 0.3s ease; touch-action: manipulation;
        }

        .achievements-btn:active { transform: scale(0.9); }

        .achievements-panel {
            position: fixed; top: 0; right: -100%;
            width: 85vw; max-width: 400px;
            height: 100vh; height: -webkit-fill-available;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 1000; transition: right 0.3s ease;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: max(env(safe-area-inset-top), 30px) 20px max(env(safe-area-inset-bottom), 30px);
        }

        .achievements-panel.open { right: 0; }

        .close-panel {
            position: absolute; top: max(env(safe-area-inset-top), 15px); right: 15px;
            background: none; border: none; font-size: 2em; cursor: pointer;
            padding: 10px; touch-action: manipulation;
        }

        .achievement-badge {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 15px; border-radius: 15px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 15px;
        }

        .achievement-badge.locked { opacity: 0.3; filter: grayscale(100%); }
        .badge-icon { font-size: 3em; }
        .badge-info h3 { margin: 0; color: #333; }
        .badge-info p { margin: 5px 0 0 0; font-size: 0.9em; color: #666; }

        .calendar-container { margin: 20px 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 10px; }

        .calendar-day {
            aspect-ratio: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: #f0f0f0; border-radius: 10px; font-size: 0.9em;
        }

        .calendar-day.completed { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: white; }
        .calendar-day .day-star { font-size: 1.5em; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }

        .modal-overlay.show { display: flex; }

        .modal-content {
            background: white; padding: 30px 20px; border-radius: 30px;
            max-width: 90vw; width: 500px; text-align: center;
            animation: bounceIn 0.5s; margin: 20px;
        }

        .modal-content h2 { color: #f5576c; margin-bottom: 20px; }

        .modal-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 15px 40px;
            font-size: 1.2em; font-family: inherit; border-radius: 15px;
            cursor: pointer; margin-top: 20px; touch-action: manipulation;
        }

        @media (max-height: 600px) and (orientation: landscape) {
            .game-header h1 { font-size: 1.3em; margin-bottom: 5px; }
            .header-stats { gap: 10px; margin-top: 10px; }
            .stat-box { padding: 8px 15px; font-size: 0.9em; }
            .progress-container { padding: 10px; }
            .scene-image { max-height: 30vh; }
            .story-text { font-size: 1em; margin-bottom: 15px; }
            .choice-btn { padding: 12px 20px; min-height: 50px; }
        }

        @media (min-width: 1024px) and (max-width: 1366px) {
            .game-container { max-width: 1000px; }
            .scene-image { max-height: 500px; }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="clouds" id="clouds"></div>

    <!-- Main Game Container -->
    <div class="game-container">
        <div class="game-header">
            <div class="audio-controls">
                <button class="audio-btn" id="musicBtn" title="Toggle Music">üéµ</button>
                <button class="audio-btn" id="soundBtn" title="Toggle Sound">üîä</button>
            </div>

            <h1>üåü Tabby's Brave School Adventure üåü</h1>

            <div class="header-stats">
                <div class="stat-box">
                    <div class="star-counter">
                        <span class="twinkling-star">‚≠ê</span>
                        <span id="stars">0</span>
                    </div>
                </div>
                <div class="stat-box">
                    <div>üî• Streak: <span id="streak">0</span> days</div>
                </div>
                <div class="stat-box">
                    <div>üèÜ Badges: <span id="badgeCount">0</span></div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%;">
                        <span class="progress-emoji" id="progressEmoji">üè†</span>
                    </div>
                </div>
                <div class="journey-map" id="journeyMap">
                    <div class="journey-step" data-step="home">üè†</div>
                    <div class="journey-line"></div>
                    <div class="journey-step" data-step="car">üöó</div>
                    <div class="journey-line"></div>
                    <div class="journey-step" data-step="gates">üè´</div>
                    <div class="journey-line"></div>
                    <div class="journey-step" data-step="doors">üö™</div>
                    <div class="journey-line"></div>
                    <div class="journey-step" data-step="classroom">üìö</div>
                </div>
            </div>
        </div>

        <div class="game-content" id="gameContent">
            <!-- Static fallback - replaced by JavaScript when it runs -->
            <noscript>
                <div style="padding: 20px; text-align: center;">
                    <p style="font-size: 1.3em; color: red; margin-bottom: 20px;">JavaScript must be enabled to play this game.</p>
                    <p>Go to: Settings ‚Üí Safari ‚Üí Advanced ‚Üí JavaScript ‚Üí ON</p>
                </div>
            </noscript>
            <div id="staticFallback">
                <div style="position: relative; margin-bottom: 30px;">
                    <img src="Tabby_small_sketch.jpg" style="width:100%; max-height:40vh; object-fit:contain; border-radius:15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" onerror="this.alt='Tabby'">
                </div>
                <div style="font-size: 1.3em; line-height: 1.6; color: #333; margin-bottom: 20px; text-align: center;">
                    Good morning, Tabby! It's time to get ready for another brave school day!
                </div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="if(typeof showScene==='function'){document.getElementById('staticFallback').remove();showScene('familyMorning');}else{alert('JavaScript error - try opening in Safari from: http://YOUR_MAC_IP:8000');}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 18px 25px; font-size: 1.2em; font-family: inherit; border-radius: 15px; cursor: pointer; min-height: 60px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                        Let's start my day! üåû
                    </button>
                </div>
                <div id="jsError" style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 15px; text-align: center; display: none;">
                    <p style="font-size: 1.1em; color: #856404;">‚ö†Ô∏è JavaScript isn't running properly on this device.</p>
                    <p style="margin-top: 10px; color: #856404;">Try opening this game from your Mac's network instead:<br>
                    Ask someone to run the server, then visit the address shown on the Mac.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Button -->
    <button class="achievements-btn" id="achievementsBtn">üèÜ</button>

    <!-- Achievements Panel -->
    <div class="achievements-panel" id="achievementsPanel">
        <button class="close-panel" id="closePanel">‚úï</button>
        <h2>üèÜ Achievements & Rewards</h2>
        <div id="badgesContainer"></div>
        <h3 style="margin-top: 30px;">üìÖ This Week</h3>
        <div class="calendar-container">
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        <h3 style="margin-top: 30px;">üõçÔ∏è Reward Shop</h3>
        <div id="shopContainer"></div>
        <h3 style="margin-top: 30px;">üìä Progress</h3>
        <div id="statsContainer"></div>
    </div>

    <!-- Modal for special events -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        // ===== GAME STATE =====
        var gameState = {
            stars: 0,
            bronzeStars: 0,
            silverStars: 0,
            goldStars: 0,
            rainbowStars: 0,
            badges: [],
            completedDays: [],
            streak: 0,
            lastPlayed: null,
            currentScene: 'start',
            progress: 0,
            hiddenStarsFound: 0,
            totalBraveChoices: 0,
            musicEnabled: true,
            soundEnabled: true,
            customizations: {},
            unlockedItems: [],
            currentWeather: 'sunny',
            currentSeason: 'spring'
        };

        // ===== LOCAL STORAGE =====
        function saveGame() {
            try {
                gameState.lastPlayed = new Date().toISOString();
                localStorage.setItem('tabbyGame', JSON.stringify(gameState));
            } catch (e) { /* localStorage may not work on some iPad file:// urls */ }
        }

        function loadGame() {
            try {
                var saved = localStorage.getItem('tabbyGame');
                if (saved) {
                    var loaded = JSON.parse(saved);
                    for (var key in loaded) {
                        if (loaded.hasOwnProperty(key)) {
                            gameState[key] = loaded[key];
                        }
                    }
                    updateAllUI();
                }
            } catch (e) { /* ignore load errors */ }
        }

        // ===== AUDIO SYSTEM (lazy-initialized for iOS) =====
        var audioContext = null;

        function getAudioContext() {
            if (!audioContext) {
                try {
                    var AC = window.AudioContext || window.webkitAudioContext;
                    if (AC) audioContext = new AC();
                } catch (e) { /* audio not available */ }
            }
            return audioContext;
        }

        function playSound(frequency, duration, type) {
            if (!gameState.soundEnabled) return;
            var ctx = getAudioContext();
            if (!ctx) return;

            try {
                // Resume context if suspended (iOS requirement)
                if (ctx.state === 'suspended') ctx.resume();

                var oscillator = ctx.createOscillator();
                var gainNode = ctx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                oscillator.frequency.value = frequency;
                oscillator.type = type || 'sine';
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);
            } catch (e) { /* ignore audio errors */ }
        }

        function playSuccessSound() {
            playSound(523.25, 0.2);
            setTimeout(function() { playSound(659.25, 0.2); }, 100);
            setTimeout(function() { playSound(783.99, 0.3); }, 200);
        }

        function playClickSound() { playSound(800, 0.1, 'square'); }

        function playStarSound() {
            playSound(1046.50, 0.15);
            setTimeout(function() { playSound(1318.51, 0.2); }, 100);
        }

        // ===== ACHIEVEMENTS SYSTEM =====
        var achievements = [
            { id: 'first_step', name: 'First Step', desc: 'Started your first day', icon: 'üë£', requirement: function() { return gameState.totalBraveChoices >= 1; } },
            { id: 'brave_heart', name: 'Brave Heart', desc: 'Made 5 brave choices', icon: 'üíñ', requirement: function() { return gameState.totalBraveChoices >= 5; } },
            { id: 'door_master', name: 'Door Master', desc: 'Reached the doors alone', icon: 'üö™', requirement: function() { return gameState.progress >= 60; } },
            { id: 'classroom_hero', name: 'Classroom Champion', desc: 'Found your classroom', icon: 'üìö', requirement: function() { return gameState.progress >= 100; } },
            { id: 'star_collector', name: 'Star Collector', desc: 'Collected 10 stars', icon: '‚≠ê', requirement: function() { return gameState.stars >= 10; } },
            { id: 'treasure_hunter', name: 'Treasure Hunter', desc: 'Found 5 hidden stars', icon: 'üîç', requirement: function() { return gameState.hiddenStarsFound >= 5; } },
            { id: 'three_day', name: '3-Day Streak', desc: 'Played 3 days in a row', icon: 'üî•', requirement: function() { return gameState.streak >= 3; } },
            { id: 'week_warrior', name: 'Week Warrior', desc: '7-day streak!', icon: 'üèÜ', requirement: function() { return gameState.streak >= 7; } }
        ];

        function checkAchievements() {
            var newBadges = [];
            achievements.forEach(function(achievement) {
                if (gameState.badges.indexOf(achievement.id) === -1 && achievement.requirement()) {
                    gameState.badges.push(achievement.id);
                    newBadges.push(achievement);
                }
            });
            if (newBadges.length > 0) {
                newBadges.forEach(function(badge) { showAchievementModal(badge); });
            }
            updateBadgesUI();
            saveGame();
        }

        function showAchievementModal(achievement) {
            var modal = document.getElementById('modalOverlay');
            var content = document.getElementById('modalContent');
            content.innerHTML = '<div style="font-size: 5em; margin-bottom: 20px;">' + achievement.icon + '</div>' +
                '<h2>üéâ New Achievement! üéâ</h2>' +
                '<h3>' + achievement.name + '</h3>' +
                '<p>' + achievement.desc + '</p>' +
                '<button class="modal-btn" onclick="closeModal()">Awesome!</button>';
            modal.classList.add('show');
            playSuccessSound();
            celebrateStar();
        }

        function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }

        function updateBadgesUI() {
            var container = document.getElementById('badgesContainer');
            container.innerHTML = '';
            achievements.forEach(function(achievement) {
                var isUnlocked = gameState.badges.indexOf(achievement.id) !== -1;
                var badge = document.createElement('div');
                badge.className = 'achievement-badge' + (!isUnlocked ? ' locked' : '');
                badge.innerHTML = '<div class="badge-icon">' + achievement.icon + '</div>' +
                    '<div class="badge-info"><h3>' + achievement.name + '</h3><p>' + achievement.desc + '</p></div>';
                container.appendChild(badge);
            });
            document.getElementById('badgeCount').textContent = gameState.badges.length;
        }

        // ===== REWARD SHOP =====
        var shopItems = [
            { id: 'rainbow_star', name: 'Rainbow Star', desc: 'A magical rainbow star!', icon: 'üåà', cost: 10 },
            { id: 'crown', name: 'Brave Crown', desc: 'Wear your bravery proudly', icon: 'üëë', cost: 15 },
            { id: 'superhero', name: 'Superhero Mode', desc: "You're a superhero!", icon: 'ü¶∏‚Äç‚ôÄÔ∏è', cost: 20 },
            { id: 'confetti_boost', name: 'Extra Confetti', desc: 'Double the celebration!', icon: 'üéä', cost: 8 },
            { id: 'golden_path', name: 'Golden Path', desc: 'Walk on gold!', icon: '‚ú®', cost: 25 },
            { id: 'friend_surprise', name: 'Friend Surprise', desc: 'Special friend visits', icon: 'üéÅ', cost: 12 }
        ];

        function updateShopUI() {
            var container = document.getElementById('shopContainer');
            container.innerHTML = '';
            shopItems.forEach(function(item) {
                var isUnlocked = gameState.unlockedItems.indexOf(item.id) !== -1;
                var canAfford = gameState.stars >= item.cost;
                var shopItem = document.createElement('div');
                shopItem.className = 'achievement-badge' + (isUnlocked ? ' locked' : '');
                shopItem.style.cursor = (!isUnlocked && canAfford) ? 'pointer' : 'default';
                shopItem.style.opacity = isUnlocked ? '0.5' : '1';
                shopItem.innerHTML = '<div class="badge-icon">' + item.icon + '</div>' +
                    '<div class="badge-info"><h3>' + item.name + (isUnlocked ? ' ‚úì' : '') + '</h3>' +
                    '<p>' + item.desc + '</p>' +
                    '<p style="color: ' + (canAfford ? '#4CAF50' : '#f44336') + '; font-weight: bold;">' +
                    (isUnlocked ? 'Owned' : item.cost + ' ‚≠ê') + '</p></div>';
                if (!isUnlocked && canAfford) {
                    (function(i) { shopItem.onclick = function() { purchaseItem(i); }; })(item);
                }
                container.appendChild(shopItem);
            });
        }

        function purchaseItem(item) {
            if (gameState.stars >= item.cost && gameState.unlockedItems.indexOf(item.id) === -1) {
                gameState.stars -= item.cost;
                gameState.unlockedItems.push(item.id);
                updateStarsUI();
                updateShopUI();
                saveGame();
                playSuccessSound();
                showMessage('üéâ You unlocked ' + item.name + '! ' + item.icon);
                if (item.id === 'crown') {
                    document.querySelector('h1').innerHTML = 'üëë Tabby\'s Brave School Adventure üëë';
                }
            }
        }

        // ===== PROGRESS TRACKING =====
        var progressSteps = {
            start: { progress: 0, step: 'home', emoji: 'üè†' },
            familyMorning: { progress: 10, step: 'home', emoji: 'üè†' },
            getReadyMummy: { progress: 20, step: 'car', emoji: 'üöó' },
            getReadyDaddy: { progress: 20, step: 'car', emoji: 'üöó' },
            journeyMummy: { progress: 40, step: 'gates', emoji: 'üè´' },
            journeyDaddy: { progress: 40, step: 'gates', emoji: 'üè´' },
            walkAlone: { progress: 60, step: 'doors', emoji: 'üö™' },
            meetFriend: { progress: 70, step: 'doors', emoji: 'üëã' },
            insideSchool: { progress: 80, step: 'doors', emoji: 'üéâ' },
            findClassroom: { progress: 90, step: 'classroom', emoji: 'üìö' },
            classroom: { progress: 100, step: 'classroom', emoji: 'üéì' },
            finale: { progress: 100, step: 'classroom', emoji: 'üèÜ' }
        };

        function updateProgress(sceneId) {
            var sceneProgress = progressSteps[sceneId];
            if (!sceneProgress) return;
            gameState.progress = sceneProgress.progress;
            document.getElementById('progressBar').style.width = gameState.progress + '%';
            document.getElementById('progressEmoji').textContent = sceneProgress.emoji;

            var steps = document.querySelectorAll('.journey-step');
            var stepOrder = ['home', 'car', 'gates', 'doors', 'classroom'];
            var currentIndex = stepOrder.indexOf(sceneProgress.step);
            for (var i = 0; i < steps.length; i++) {
                steps[i].classList.remove('active', 'completed');
                var stepName = steps[i].getAttribute('data-step');
                if (stepName === sceneProgress.step) {
                    steps[i].classList.add('active');
                } else if (stepOrder.indexOf(stepName) < currentIndex) {
                    steps[i].classList.add('completed');
                }
            }
        }

        // ===== STREAK TRACKING =====
        function updateStreak() {
            var today = new Date().toDateString();
            var yesterday = new Date(Date.now() - 86400000).toDateString();
            if (gameState.completedDays.indexOf(today) === -1) {
                gameState.completedDays.push(today);
                if (gameState.lastPlayed) {
                    var lastDate = new Date(gameState.lastPlayed).toDateString();
                    if (lastDate === yesterday || lastDate === today) { gameState.streak++; }
                    else if (lastDate !== today) { gameState.streak = 1; }
                } else { gameState.streak = 1; }
                saveGame();
            }
            document.getElementById('streak').textContent = gameState.streak;
            updateCalendar();
        }

        function updateCalendar() {
            var grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            var today = new Date();
            var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            for (var i = 6; i >= 0; i--) {
                var date = new Date(today);
                date.setDate(date.getDate() - i);
                var dateStr = date.toDateString();
                var day = document.createElement('div');
                day.className = 'calendar-day';
                if (gameState.completedDays.indexOf(dateStr) !== -1) day.classList.add('completed');
                day.innerHTML = '<div>' + dayNames[date.getDay()] + '</div><div>' + date.getDate() + '</div>' +
                    (gameState.completedDays.indexOf(dateStr) !== -1 ? '<div class="day-star">‚≠ê</div>' : '');
                grid.appendChild(day);
            }
        }

        function updateStatsDisplay() {
            document.getElementById('statsContainer').innerHTML =
                '<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 15px; color: white;">' +
                '<h4 style="margin: 0 0 15px 0;">Tabby\'s Amazing Stats!</h4>' +
                '<div style="display: grid; gap: 10px;">' +
                '<div>‚≠ê Total Stars: <strong>' + gameState.stars + '</strong></div>' +
                '<div>ü•â Bronze Stars: <strong>' + gameState.bronzeStars + '</strong></div>' +
                '<div>ü•à Silver Stars: <strong>' + gameState.silverStars + '</strong></div>' +
                '<div>ü•á Gold Stars: <strong>' + gameState.goldStars + '</strong></div>' +
                '<div>üí™ Brave Choices: <strong>' + gameState.totalBraveChoices + '</strong></div>' +
                '<div>üîç Hidden Stars Found: <strong>' + gameState.hiddenStarsFound + '</strong></div>' +
                '<div>üéÆ Days Played: <strong>' + gameState.completedDays.length + '</strong></div>' +
                '<div>üî• Current Streak: <strong>' + gameState.streak + ' days</strong></div>' +
                '</div></div>';
        }

        // ===== CELEBRATIONS =====
        function createFireworks(x, y) {
            var colors = ['#f093fb', '#f5576c', '#667eea', '#764ba2', '#84fab0', '#8fd3f4', '#ffd700', '#ff69b4'];
            var container = document.createElement('div');
            container.className = 'fireworks-container';
            document.body.appendChild(container);
            for (var burst = 0; burst < 3; burst++) {
                (function(b) {
                    setTimeout(function() {
                        var centerX = x || Math.random() * window.innerWidth;
                        var centerY = y || Math.random() * (window.innerHeight / 2);
                        for (var i = 0; i < 30; i++) {
                            var firework = document.createElement('div');
                            firework.className = 'firework';
                            var angle = (Math.PI * 2 * i) / 30;
                            var velocity = 50 + Math.random() * 100;
                            firework.style.left = centerX + 'px';
                            firework.style.top = centerY + 'px';
                            firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                            firework.style.setProperty('--tx', Math.cos(angle) * velocity + 'px');
                            firework.style.setProperty('--ty', Math.sin(angle) * velocity + 'px');
                            container.appendChild(firework);
                        }
                    }, b * 300);
                })(burst);
            }
            setTimeout(function() { container.remove(); }, 2000);
        }

        function createStarBurst() {
            var starEmojis = ['‚≠ê', 'üåü', '‚ú®', 'üí´'];
            for (var i = 0; i < 8; i++) {
                (function(idx) {
                    setTimeout(function() {
                        var star = document.createElement('div');
                        star.className = 'star-burst';
                        star.textContent = starEmojis[Math.floor(Math.random() * starEmojis.length)];
                        star.style.left = Math.random() * window.innerWidth + 'px';
                        star.style.top = (window.innerHeight / 2) + 'px';
                        document.body.appendChild(star);
                        setTimeout(function() { star.remove(); }, 1500);
                    }, idx * 100);
                })(i);
            }
        }

        function createConfetti() {
            var colors = ['#f093fb', '#f5576c', '#667eea', '#84fab0', '#ffd700', '#ff69b4', '#00f5ff'];
            var count = gameState.unlockedItems.indexOf('confetti_boost') !== -1 ? 100 : 50;
            for (var i = 0; i < count; i++) {
                (function(idx) {
                    setTimeout(function() {
                        var confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * window.innerWidth + 'px';
                        confetti.style.top = '-20px';
                        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        document.body.appendChild(confetti);
                        setTimeout(function() { confetti.remove(); }, 2000);
                    }, idx * 30);
                })(i);
            }
        }

        function celebrateStar() { createFireworks(); createStarBurst(); createConfetti(); playStarSound(); }

        // ===== CHARACTERS =====
        var characters = {
            milo: { name: 'Friend', cls: 'character-milo', greeting: 'Hi Tabby! Want to walk together?' },
            sadie: { name: 'Friend', cls: 'character-sadie', greeting: "Tabby! I'm so happy to see you!" },
            isabelle: { name: 'Friend', cls: 'character-isabelle', greeting: 'Good morning, Tabby!' },
            teddy: { name: 'Friend', cls: 'character-teddy', greeting: "Hey Tabby! Let's have fun today!" },
            collis: { name: 'Teacher', accessory: 'üìö', cls: 'character-collis', greeting: 'Welcome, Tabby!' },
            kane: { name: 'Teacher', accessory: '‚úèÔ∏è', cls: 'character-kane', greeting: 'You did so well today!' }
        };

        function createCharacters(characterIds) {
            var container = document.createElement('div');
            container.className = 'characters-container';
            characterIds.forEach(function(id) {
                var ch = characters[id];
                var charDiv = document.createElement('div');
                charDiv.className = 'character ' + ch.cls;
                charDiv.title = ch.greeting;
                (function(greeting) {
                    charDiv.onclick = function() { playClickSound(); showMessage(greeting); };
                })(ch.greeting);

                var avatar = document.createElement('div');
                avatar.className = 'character-avatar';
                var head = document.createElement('div');
                head.className = 'character-head';
                var hair = document.createElement('div');
                hair.className = 'character-hair';
                head.appendChild(hair);
                var eyes = document.createElement('div');
                eyes.className = 'character-eyes';
                var leftEye = document.createElement('div');
                leftEye.className = 'eye';
                var rightEye = document.createElement('div');
                rightEye.className = 'eye';
                eyes.appendChild(leftEye);
                eyes.appendChild(rightEye);
                head.appendChild(eyes);
                var mouth = document.createElement('div');
                mouth.className = 'character-mouth';
                head.appendChild(mouth);
                avatar.appendChild(head);
                var body = document.createElement('div');
                body.className = 'character-body';
                avatar.appendChild(body);
                if (ch.accessory) {
                    var acc = document.createElement('div');
                    acc.className = 'character-accessory';
                    acc.textContent = ch.accessory;
                    avatar.appendChild(acc);
                }
                var name = document.createElement('div');
                name.className = 'character-name';
                name.textContent = ch.name;
                charDiv.appendChild(avatar);
                charDiv.appendChild(name);
                container.appendChild(charDiv);
            });
            return container;
        }

        function showMessage(text) {
            var msg = document.createElement('div');
            msg.className = 'encouragement';
            msg.textContent = text;
            msg.style.position = 'fixed';
            msg.style.top = '50%';
            msg.style.left = '50%';
            msg.style.transform = 'translate(-50%, -50%)';
            msg.style.zIndex = '10000';
            document.body.appendChild(msg);
            setTimeout(function() { msg.remove(); }, 2000);
        }

        // ===== GAME SCENES =====
        var scenes = {
            start: {
                image: 'Tabby_small_sketch.jpg',
                text: "Good morning, Tabby! It's time to get ready for another brave school day!",
                choices: [{ text: "Let's start my day! üåû", next: 'familyMorning', brave: false }],
                hiddenStars: 2
            },
            familyMorning: {
                image: 'brother_small_sketch.jpg',
                text: 'Your brother is having breakfast too! Who is taking you to school today?',
                choices: [
                    { text: 'Mummy is taking me! üíï', next: 'getReadyMummy', brave: false },
                    { text: 'Daddy is taking me! üíô', next: 'getReadyDaddy', brave: false }
                ],
                hiddenStars: 1
            },
            getReadyMummy: {
                image: 'Mummy_small_sketch.jpg',
                text: 'Mummy is taking you to school today! Are you excited?',
                choices: [
                    { text: 'Yes! I love school! üòä', next: 'journeyMummy', brave: true, starType: 'silver' },
                    { text: 'I feel a bit nervous...', next: 'encouragement1Mummy', brave: false }
                ]
            },
            encouragement1Mummy: {
                image: 'Mummy_small_sketch.jpg',
                text: "That's okay, Tabby! Mummy says: \"You're so brave, and your friends will be so happy to see you!\"",
                choices: [{ text: "Okay, let's go! üí™", next: 'journeyMummy', brave: true, starType: 'bronze' }]
            },
            journeyMummy: {
                image: 'school_sketch.jpg',
                text: "You've arrived at school with Mummy! You can see the big doors.",
                choices: [
                    { text: 'I want to walk to the doors myself! üö∂‚Äç‚ôÄÔ∏è', next: 'walkAlone', brave: true, starType: 'gold' },
                    { text: 'Can Mummy come with me?', next: 'encouragement2Mummy', brave: false }
                ],
                hiddenStars: 2
            },
            encouragement2Mummy: {
                image: 'Mummy_small_sketch.jpg',
                text: "Mummy says: \"I'll be right here watching. You can do this! You're such a big girl now!\"",
                choices: [{ text: "Okay! I'll try! üí™", next: 'walkAlone', brave: true, starType: 'silver' }]
            },
            getReadyDaddy: {
                image: 'Daddy_small_sketch.jpg',
                text: 'Daddy is taking you to school today! Are you excited?',
                choices: [
                    { text: 'Yes! I love school! üòä', next: 'journeyDaddy', brave: true, starType: 'silver' },
                    { text: 'I feel a bit nervous...', next: 'encouragement1Daddy', brave: false }
                ]
            },
            encouragement1Daddy: {
                image: 'Daddy_small_sketch.jpg',
                text: "That's okay, Tabby! Daddy says: \"You're so brave, and your friends will be so happy to see you!\"",
                choices: [{ text: "Okay, let's go! üí™", next: 'journeyDaddy', brave: true, starType: 'bronze' }]
            },
            journeyDaddy: {
                image: 'school_sketch.jpg',
                text: "You've arrived at school with Daddy! You can see the big doors.",
                choices: [
                    { text: 'I want to walk to the doors myself! üö∂‚Äç‚ôÄÔ∏è', next: 'walkAlone', brave: true, starType: 'gold' },
                    { text: 'Can Daddy come with me?', next: 'encouragement2Daddy', brave: false }
                ],
                hiddenStars: 2
            },
            encouragement2Daddy: {
                image: 'Daddy_small_sketch.jpg',
                text: "Daddy says: \"I'll be right here watching. You can do this! You're such a big girl now!\"",
                choices: [{ text: "Okay! I'll try! üí™", next: 'walkAlone', brave: true, starType: 'silver' }]
            },
            walkAlone: {
                image: 'school_sketch.jpg',
                text: "üåü WOW! You're walking to the doors all by yourself! You're being SO brave!",
                celebration: 'üéâ Amazing! You earned a bravery star! üåü',
                choices: [{ text: 'Keep going! ‚û°Ô∏è', next: 'meetFriend', brave: false }]
            },
            meetFriend: {
                image: 'Tabby_small_sketch.jpg',
                text: 'Look! You can see your friends inside!',
                characters: ['milo', 'sadie', 'isabelle', 'teddy'],
                choices: [{ text: "I'll wave hello! üëã", next: 'insideSchool', brave: true, starType: 'silver' }]
            },
            insideSchool: {
                image: 'school_sketch.jpg',
                text: 'üåü You walked through the doors all by yourself! Your friends are so happy to see you!',
                celebration: 'üéä Another bravery star! You did it! üåü',
                choices: [{ text: 'Find my classroom! üè´', next: 'findClassroom', brave: false }]
            },
            findClassroom: {
                image: 'Tabby_small_sketch.jpg',
                text: 'Do you remember where your classroom is?',
                choices: [
                    { text: 'Yes! I can find it myself! üéØ', next: 'classroom', brave: true, starType: 'gold' },
                    { text: "I'll ask a friend to show me!", next: 'classroom', brave: true, starType: 'bronze' }
                ]
            },
            classroom: {
                image: 'Tabby_small_sketch.jpg',
                text: 'üåü You found your classroom! Your teachers are so proud of you!',
                characters: ['collis', 'kane'],
                celebration: '‚≠ê You earned another star for being independent! ‚≠ê',
                choices: [{ text: 'Start my school day! üìö', next: 'finale', brave: false }]
            },
            finale: {
                image: 'Tabby_small_sketch.jpg',
                text: 'üéâ üåü TABBY, YOU DID IT! üåü üéâ<br><br>You went into school ALL BY YOURSELF!<br><br>You are brave, confident, and amazing!',
                celebration: "üèÜ YOU'RE A SUPERSTAR! üèÜ",
                choices: [{ text: 'See everyone proud of me! üíï', next: 'familyProud', brave: false }]
            },
            familyProud: {
                image: 'Monty_small_sketch.jpg',
                text: 'At home, Monty is waiting for you! And Mummy, Daddy, and your brother are all SO PROUD of what a brave girl you are!<br><br>Tomorrow, you can do it again!',
                choices: [{ text: 'Play Again! üîÑ', next: 'start', brave: false }]
            }
        };

        // ===== HIDDEN STARS =====
        function addHiddenStars(count) {
            var container = document.querySelector('.scene-image-container');
            if (!container) return;
            for (var i = 0; i < count; i++) {
                var star = document.createElement('div');
                star.className = 'hidden-star';
                star.textContent = '‚≠ê';
                star.style.left = (20 + Math.random() * 60) + '%';
                star.style.top = (20 + Math.random() * 60) + '%';
                (function(s) {
                    s.onclick = function() {
                        playStarSound();
                        gameState.hiddenStarsFound++;
                        gameState.stars++;
                        updateStarsUI();
                        s.style.animation = 'burstUp 1s ease-out forwards';
                        setTimeout(function() { s.remove(); }, 1000);
                        showMessage('You found a hidden star! ‚≠ê');
                        checkAchievements();
                        saveGame();
                    };
                })(star);
                container.appendChild(star);
            }
        }

        // ===== UI UPDATES =====
        function updateStarsUI() { document.getElementById('stars').textContent = gameState.stars; }

        function updateAllUI() {
            updateStarsUI();
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('badgeCount').textContent = gameState.badges.length;
            updateBadgesUI();
            updateCalendar();
            updateShopUI();
            updateStatsDisplay();
        }

        // ===== WEATHER =====
        function getRandomWeather() {
            var weathers = ['sunny', 'cloudy', 'rainy', 'rainbow'];
            return weathers[Math.floor(Math.random() * weathers.length)];
        }

        function addWeatherEffect() {
            var weather = gameState.currentWeather;
            var container = document.querySelector('.scene-image-container');
            if (!container) return;
            var icons = { sunny: '‚òÄÔ∏è', cloudy: '‚òÅÔ∏è', rainy: 'üåßÔ∏è', rainbow: 'üåà' };
            var icon = icons[weather] || '‚òÄÔ∏è';
            var effect = document.createElement('div');
            effect.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;';
            effect.innerHTML = '<div style="position:absolute;top:20px;right:20px;font-size:3em;">' + icon + '</div>';
            container.appendChild(effect);
        }

        // ===== SCENE DISPLAY =====
        function showScene(sceneId) {
            gameState.currentScene = sceneId;
            var scene = scenes[sceneId];
            if (!scene) return;
            var content = document.getElementById('gameContent');
            if (!content) return;

            content.innerHTML = '';
            content.className = 'game-content scene-transition';
            updateProgress(sceneId);

            // Image container
            var imgContainer = document.createElement('div');
            imgContainer.className = 'scene-image-container';
            var img = document.createElement('img');
            img.src = scene.image;
            img.className = 'scene-image';
            img.onerror = function() { this.style.display = 'none'; };
            imgContainer.appendChild(img);
            content.appendChild(imgContainer);

            // Hidden stars
            if (scene.hiddenStars) {
                setTimeout(function() { addHiddenStars(scene.hiddenStars); }, 500);
            }

            // Weather
            setTimeout(function() { addWeatherEffect(); }, 600);

            // Story text
            var text = document.createElement('div');
            text.className = 'story-text';
            text.innerHTML = scene.text;
            content.appendChild(text);

            // Characters
            if (scene.characters) {
                content.appendChild(createCharacters(scene.characters));
            }

            // Celebration
            if (scene.celebration) {
                var celebration = document.createElement('div');
                celebration.className = 'encouragement';
                celebration.innerHTML = scene.celebration;
                content.appendChild(celebration);
            }

            // Choices
            var choicesDiv = document.createElement('div');
            choicesDiv.className = 'choices';
            scene.choices.forEach(function(choice) {
                var btn = document.createElement('button');
                btn.className = 'choice-btn';
                if (choice.brave) {
                    btn.classList.add('brave');
                    btn.innerHTML = choice.text + ' <span class="star-icon">‚≠ê</span>';
                } else {
                    btn.textContent = choice.text;
                }
                (function(c) {
                    btn.onclick = function() {
                        playClickSound();
                        if (c.brave) {
                            gameState.totalBraveChoices++;
                            gameState.stars++;
                            var starType = c.starType || 'bronze';
                            if (starType === 'bronze') gameState.bronzeStars++;
                            else if (starType === 'silver') gameState.silverStars++;
                            else if (starType === 'gold') gameState.goldStars++;
                            else if (starType === 'rainbow') gameState.rainbowStars++;
                            updateStarsUI();
                            celebrateStar();
                            checkAchievements();
                            saveGame();
                        }
                        if (c.next === 'start') {
                            gameState.progress = 0;
                            updateStreak();
                            saveGame();
                        }
                        setTimeout(function() { showScene(c.next); }, c.brave ? 500 : 0);
                    };
                })(choice);
                choicesDiv.appendChild(btn);
            });
            content.appendChild(choicesDiv);
        }

        // ===== BACKGROUND ANIMATIONS =====
        function createClouds() {
            var container = document.getElementById('clouds');
            for (var i = 0; i < 5; i++) {
                var cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.style.width = (60 + Math.random() * 80) + 'px';
                cloud.style.height = (30 + Math.random() * 40) + 'px';
                cloud.style.top = (Math.random() * 50) + '%';
                cloud.style.animationDuration = (15 + Math.random() * 20) + 's';
                cloud.style.animationDelay = (Math.random() * 10) + 's';
                container.appendChild(cloud);
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            document.getElementById('achievementsBtn').onclick = function() {
                playClickSound();
                document.getElementById('achievementsPanel').classList.add('open');
            };
            document.getElementById('closePanel').onclick = function() {
                playClickSound();
                document.getElementById('achievementsPanel').classList.remove('open');
            };
            document.getElementById('musicBtn').onclick = function() {
                playClickSound();
                gameState.musicEnabled = !gameState.musicEnabled;
                document.getElementById('musicBtn').classList.toggle('muted');
                saveGame();
            };
            document.getElementById('soundBtn').onclick = function() {
                gameState.soundEnabled = !gameState.soundEnabled;
                document.getElementById('soundBtn').classList.toggle('muted');
                saveGame();
                if (gameState.soundEnabled) playClickSound();
            };
            document.getElementById('modalOverlay').onclick = function(e) {
                if (e.target.id === 'modalOverlay') closeModal();
            };
        }

        // ===== INITIALIZATION =====
        // Runs immediately - script is at end of body so DOM is ready
        try {
            loadGame();
            gameState.currentWeather = gameState.currentWeather || getRandomWeather();
            setupEventListeners();
            createClouds();
            // Remove static fallback and show dynamic content
            var fallback = document.getElementById('staticFallback');
            if (fallback) fallback.remove();
            showScene('start');
            updateStreak();
            saveGame();
        } catch (e) {
            // Show error visually if JS partially works
            var errDiv = document.getElementById('jsError');
            if (errDiv) {
                errDiv.style.display = 'block';
                errDiv.innerHTML = '<p style="font-size:1.1em;color:#856404;">‚ö†Ô∏è Error: ' + e.message + '</p>' +
                    '<p style="margin-top:10px;color:#856404;">Try serving from your Mac instead (see below).</p>';
            }
        }
    </script>
</body>
</html>
